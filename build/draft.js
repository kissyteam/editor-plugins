KISSY.add('kg/editor-plugins/1.1.2/draft',["editor","json","event/dom","./local-storage","overlay","./menubutton","util","node"],function(S ,require, exports, module) {function e(e,t,n){for(e+="";e.length<t;)e=n+e;return e}function t(t){return"number"==typeof t&&(t=new Date(t)),t instanceof Date?[t.getFullYear(),"-",e(t.getMonth()+1,2,"0"),"-",e(t.getDate(),2,"0")," ",e(t.getHours(),2,"0"),":",e(t.getMinutes(),2,"0"),":",e(t.getSeconds(),2,"0")].join(""):t}function n(e,t){this.editor=e,this.config=t,this._init()}function i(e,t){var i=new n(e,t);e.on("destroy",function(){i.destroy()})}function o(e){this.config=e||{}}var r=require("editor"),a=require("json"),l=require("event/dom"),s=require("./local-storage"),d=require("overlay"),p=require("./menubutton"),c=require("util"),f=require("node"),u=5,h=5,v="ks-editor-draft-save20110503",g=r.Utils.addRes,m=r.Utils.destroyRes;c.augment(n,{_getSaveKey:function(){var e=this,t=e.config;return t.saveKey||v},_getDrafts:function(){var e=this;if(!e.drafts){var t=s.getItem(e._getSaveKey()),n=[];t&&(n=s===window.localStorage?a.parse(c.urlDecode(t)):t),e.drafts=n}return e.drafts},_init:function(){var e=this,t=e.editor,n=t.get("prefixCls"),i=t.get("statusBarEl"),o=this.config;o.limit=o.limit||u,o.interval=o.interval||h;var a=f('<div class="'+n+'editor-draft"><span class="'+n+'editor-draft-title">内容正文每'+o.interval+"分钟自动保存一次。</span></div>").appendTo(i);e.timeTip=f('<span class="'+n+'editor-draft-time"/>').appendTo(a);var s=f(c.substitute('<a href="#" onclick="return false;" class="{prefixCls}editor-button {prefixCls}editor-draft-save-btn ks-inline-block" style="vertical-align:middle;padding:1px 9px;"><span class="{prefixCls}editor-draft-save"></span><span>立即保存</span></a>',{prefixCls:n})).unselectable(void 0).appendTo(a),d=new p({render:a,collapseOnClick:!0,width:"100px",prefixCls:n+"editor-",menu:{width:"225px",align:{points:["tr","br"]}},matchElWidth:!1,content:"恢复编辑历史"}).render();e.versions=d,d.on("beforeCollapsedChange",function b(t){t.newValue||(d.detach("beforeCollapsedChange",b),e.sync())}),s.on("click",function(t){e.save(!1),t.halt()}),g.call(e,s),t.get("textarea")[0].form&&!function(){function n(){e.save(!0)}var i=t.get("textarea"),o=i[0].form;l.on(o,"submit",n),g.call(e,function(){l.remove(o,"submit",n)})}();var v=setInterval(function(){e.save(!0)},60*e.config.interval*1e3);if(g.call(e,function(){clearInterval(v)}),d.on("click",e.recover,e),g.call(e,d),e.holder=a,o.helpHtml){var m=f('<a tabindex="0" hidefocus="hidefocus" class="'+n+'editor-draft-help" title="点击查看帮助" href="javascript:void(\'点击查看帮助 \')">点击查看帮助</a>').unselectable(void 0).appendTo(a);m.on("click",function(){m[0].focus(),e.helpPopup&&e.helpPopup.get("visible")?e.helpPopup.hide():e._prepareHelp()}),m.on("blur",function(){e.helpPopup&&e.helpPopup.hide()}),e.helpBtn=m,g.call(e,m),r.Utils.lazyRun(e,"_prepareHelp","_realHelp")}g.call(e,a)},_prepareHelp:function(){var e=this,t=e.editor,n=t.get("prefixCls"),i=e.config,o=i,a=f(o.helpHtml||""),l="height:0;position:absolute;font-size:0;width:0;border:8px #000 solid;border-color:#000 transparent transparent transparent;border-style:solid dashed dashed dashed;",s=f('<div style="'+l+'border-top-color:#CED5E0;"><div style="'+l+'left:-8px;top:-10px;border-top-color:white;"></div></div>');a.append(s),a.css({border:"1px solid #ACB4BE","text-align":"left"}),e.helpPopup=new d({prefixCls:n+"editor-",width:a.outerWidth()+"px",zIndex:r.baseZIndex(r.ZIndexManager.OVERLAY),mask:!1}).render(),e.helpPopup.get("contentEl").append(a),e.helpPopup.get("el").css({border:"none",overflow:"visible"}),e.helpPopup.arrow=s},_realHelp:function(){var e=this.helpPopup,t=this.helpBtn,n=e.arrow;e.show();var i=t.offset();e.get("el").offset({left:i.left-e.get("el").width()+17,top:i.top-e.get("el").height()-7}),n.offset({left:i.left-2,top:i.top-8})},disable:function(){this.holder.css("visibility","hidden")},enable:function(){this.holder.css("visibility","")},sync:function(){var e,n,i,o=this,r=o.timeTip,l=o.versions,d=o._getDrafts();for(d.length>o.config.limit&&d.splice(0,d.length-o.config.limit),l.removeItems(!0),e=0;e<d.length;e++)n=d[e],i=(n.auto?"自动":"手动")+"保存于 : "+t(n.date),l.addItem({content:i,value:e});d.length||l.addItem({disabled:!0,content:"尚无历史",value:""}),r.html(i),s.setItem(o._getSaveKey(),s===window.localStorage?encodeURIComponent(a.stringify(d)):d)},save:function(e){var t=this,n=t._getDrafts(),i=t.editor,o=i.getFormatData();o&&(n[n.length-1]&&o===n[n.length-1].content&&(n.length-=1),t.drafts=n.concat({content:o,date:(new Date).getTime(),auto:e}),t.sync())},recover:function(e){var n=this,i=n.editor,o=n._getDrafts(),r=e.target.get("value");window.confirm("确认恢复 "+t(o[r].date)+" 的编辑历史？")&&(i.execCommand("save"),i.setData(o[r].content),i.execCommand("save")),e.halt()},destroy:function(){m.call(this)}}),c.augment(o,{pluginRenderUI:function(e){var t=this.config;s.ready?s.ready(function(){i(e,t)}):i(e,t)}}),module.exports=o;});