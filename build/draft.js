define("kg/editor-plugins/1.1.3/draft",["editor","json","event-dom","./local-storage","overlay","./menubutton","util","node"],function(e,t,n){function o(e,t,n){for(e+="";e.length<t;)e=n+e;return e}function i(e){return"number"==typeof e&&(e=new Date(e)),e instanceof Date?[e.getFullYear(),"-",o(e.getMonth()+1,2,"0"),"-",o(e.getDate(),2,"0")," ",o(e.getHours(),2,"0"),":",o(e.getMinutes(),2,"0"),":",o(e.getSeconds(),2,"0")].join(""):e}function a(e,t){this.editor=e,this.config=t,this._init()}function r(e,t){var n=new a(e,t);e.on("destroy",function(){n.destroy()})}function l(e){this.config=e||{}}var s=e("editor"),d=e("json"),p=e("event-dom"),c=e("./local-storage"),f=e("overlay"),u=e("./menubutton"),h=e("util"),v=e("node"),g=5,m=5,b="ks-editor-draft-save20110503",x=s.Utils.addRes,y=s.Utils.destroyRes;h.augment(a,{_getSaveKey:function(){var e=this,t=e.config;return t.saveKey||b},_getDrafts:function(){var e=this;if(!e.drafts){var t=c.getItem(e._getSaveKey()),n=[];t&&(n=c===window.localStorage?d.parse(h.urlDecode(t)):t),e.drafts=n}return e.drafts},_init:function(){var e=this,t=e.editor,n=t.get("prefixCls"),o=t.get("statusBarEl"),i=this.config;i.limit=i.limit||g,i.interval=i.interval||m;var a=v('<div class="'+n+'editor-draft"><span class="'+n+'editor-draft-title">内容正文每'+i.interval+"分钟自动保存一次。</span></div>").appendTo(o);e.timeTip=v('<span class="'+n+'editor-draft-time"/>').appendTo(a);var r=v(h.substitute('<a href="#" onclick="return false;" class="{prefixCls}editor-button {prefixCls}editor-draft-save-btn ks-inline-block" style="vertical-align:middle;padding:1px 9px;"><span class="{prefixCls}editor-draft-save"></span><span>立即保存</span></a>',{prefixCls:n})).unselectable(void 0).appendTo(a),l=new u({render:a,collapseOnClick:!0,width:"100px",prefixCls:n+"editor-",menu:{width:"225px",align:{points:["tr","br"]}},matchElWidth:!1,content:"恢复编辑历史"}).render();e.versions=l,l.on("beforeCollapsedChange",function f(t){t.newValue||(l.detach("beforeCollapsedChange",f),e.sync())}),r.on("click",function(t){e.save(!1),t.halt()}),x.call(e,r),t.get("textarea")[0].form&&!function(){function n(){e.save(!0)}var o=t.get("textarea"),i=o[0].form;p.on(i,"submit",n),x.call(e,function(){p.remove(i,"submit",n)})}();var d=setInterval(function(){e.save(!0)},60*e.config.interval*1e3);if(x.call(e,function(){clearInterval(d)}),l.on("click",e.recover,e),x.call(e,l),e.holder=a,i.helpHtml){var c=v('<a tabindex="0" hidefocus="hidefocus" class="'+n+'editor-draft-help" title="点击查看帮助" href="javascript:void(\'点击查看帮助 \')">点击查看帮助</a>').unselectable(void 0).appendTo(a);c.on("click",function(){c[0].focus(),e.helpPopup&&e.helpPopup.get("visible")?e.helpPopup.hide():e._prepareHelp()}),c.on("blur",function(){e.helpPopup&&e.helpPopup.hide()}),e.helpBtn=c,x.call(e,c),s.Utils.lazyRun(e,"_prepareHelp","_realHelp")}x.call(e,a)},_prepareHelp:function(){var e=this,t=e.editor,n=t.get("prefixCls"),o=e.config,i=o,a=v(i.helpHtml||""),r="height:0;position:absolute;font-size:0;width:0;border:8px #000 solid;border-color:#000 transparent transparent transparent;border-style:solid dashed dashed dashed;",l=v('<div style="'+r+'border-top-color:#CED5E0;"><div style="'+r+'left:-8px;top:-10px;border-top-color:white;"></div></div>');a.append(l),a.css({border:"1px solid #ACB4BE","text-align":"left"}),e.helpPopup=new f({prefixCls:n+"editor-",width:a.outerWidth()+"px",zIndex:s.baseZIndex(s.ZIndexManager.OVERLAY),mask:!1}).render(),e.helpPopup.get("contentEl").append(a),e.helpPopup.get("el").css({border:"none",overflow:"visible"}),e.helpPopup.arrow=l},_realHelp:function(){var e=this.helpPopup,t=this.helpBtn,n=e.arrow;e.show();var o=t.offset();e.get("el").offset({left:o.left-e.get("el").width()+17,top:o.top-e.get("el").height()-7}),n.offset({left:o.left-2,top:o.top-8})},disable:function(){this.holder.css("visibility","hidden")},enable:function(){this.holder.css("visibility","")},sync:function(){var e,t,n,o=this,a=o.timeTip,r=o.versions,l=o._getDrafts();for(l.length>o.config.limit&&l.splice(0,l.length-o.config.limit),r.removeItems(!0),e=0;e<l.length;e++)t=l[e],n=(t.auto?"自动":"手动")+"保存于 : "+i(t.date),r.addItem({content:n,value:e});l.length||r.addItem({disabled:!0,content:"尚无历史",value:""}),a.html(n),c.setItem(o._getSaveKey(),c===window.localStorage?encodeURIComponent(d.stringify(l)):l)},save:function(e){var t=this,n=t._getDrafts(),o=t.editor,i=o.getFormatData();i&&(n[n.length-1]&&i===n[n.length-1].content&&(n.length-=1),t.drafts=n.concat({content:i,date:(new Date).getTime(),auto:e}),t.sync())},recover:function(e){var t=this,n=t.editor,o=t._getDrafts(),a=e.target.get("value");window.confirm("确认恢复 "+i(o[a].date)+" 的编辑历史？")&&(n.execCommand("save"),n.setData(o[a].content),n.execCommand("save")),e.halt()},destroy:function(){y.call(this)}}),h.augment(l,{pluginRenderUI:function(e){var t=this.config;c.ready?c.ready(function(){r(e,t)}):r(e,t)}}),n.exports=l});