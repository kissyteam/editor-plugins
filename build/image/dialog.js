define("kg/editor-plugins/1.1.7/image/dialog",["util","editor","io","../dialog","tabs","../menubutton","./dialog-tpl","ua","node"],function(e,i,t){function a(e){for(var i=e;i;){var t=i.nodeName();if("a"===t)return i;if(f.$block[t]||f.$blockLimit[t])return null;i=i.parent()}return null}function n(e,i){var t=this;t.editor=e,t.imageCfg=i||{},t.cfg=t.imageCfg.upload||null,t.suffix=t.cfg&&t.cfg.suffix||"png,jpg,jpeg,gif",t.suffixReg=new RegExp(t.suffix.split(/,/).join("|")+"$","i"),t.suffixWarning="只允许后缀名为"+t.suffix+"的图片"}var r=e("util"),l=e("editor"),o=e("io"),g=e("../dialog"),s=e("tabs"),m=e("../menubutton"),d=e("./dialog-tpl"),f=l.XHTML_DTD,c=e("ua"),u=e("node"),p="http://",h="自动",v=10,k='<div style="padding:5px 20px 20px;"><a href="javascript:void(\'确定\')" class="{prefixCls}img-insert {prefixCls}button ks-inline-block" style="margin-right:30px;">确定</a> <a  href="javascript:void(\'取消\')" class="{prefixCls}img-cancel {prefixCls}button ks-inline-block">取消</a></div>',b="请点击浏览上传图片",x=l.Utils.valInput;n.prototype={_prepare:function(){function e(e){return e.files?e.files[0].size:0}var i=this,t=i.editor,a=t.get("prefixCls")+"editor-";i.dialog=i.d=new g({width:500,headerContent:"图片",bodyContent:r.substitute(d,{prefixCls:a}),footerContent:r.substitute(k,{prefixCls:a}),mask:!0}).render();var n=i.d.get("el"),f=n.one("."+a+"img-cancel"),v=n.one("."+a+"img-insert"),C=l.Utils.verifyInputs,L=n.one("."+a+"img-setting");i.uploadForm=n.one("."+a+"img-upload-form"),i.imgLocalUrl=n.one("."+a+"img-local-url"),i.tab=new s({srcNode:i.d.get("body").one("."+a+"img-tabs"),prefixCls:a+"img-"}).render(),i.imgLocalUrl.val(b),i.imgUrl=n.one("."+a+"img-url"),i.imgHeight=n.one("."+a+"img-height"),i.imgWidth=n.one("."+a+"img-width"),i.imgRatio=n.one("."+a+"img-ratio"),i.imgAlign=m.Select.decorate(n.one("."+a+"img-align"),{prefixCls:a+"big-",width:80,menuCfg:{prefixCls:a+"",render:n}}),i.imgMargin=n.one("."+a+"img-margin"),i.imgLink=n.one("."+a+"img-link"),i.imgLinkBlank=n.one("."+a+"img-link-blank");var _=l.Utils.placeholder;_(i.imgUrl,p),_(i.imgHeight,h),_(i.imgWidth,h),_(i.imgLink,"http://"),i.imgHeight.on("keyup",function(){var e=parseInt(x(i.imgHeight),10);e&&i.imgRatio[0].checked&&!i.imgRatio[0].disabled&&i.imgRatioValue&&x(i.imgWidth,Math.floor(e*i.imgRatioValue))}),i.imgWidth.on("keyup",function(){var e=parseInt(x(i.imgWidth),10);e&&i.imgRatio[0].checked&&!i.imgRatio[0].disabled&&i.imgRatioValue&&x(i.imgHeight,Math.floor(e/i.imgRatioValue))}),f.on("click",function(e){i.d.hide(),e.halt()});var y=u('<a class="'+a+'button ks-inline-block" style="position:absolute;z-index:'+l.baseZIndex(l.ZIndexManager.LOADING_CANCEL)+';left:-9999px;top:-9999px;">取消上传</a>').appendTo(document.body,void 0);if(i.loadingCancel=y,v.on("click",function(t){if(t.halt(),i.imageCfg.remote!==!1&&1!==r.indexOf(i.tab.getSelectedTab(),i.tab.getTabs())||!i.cfg){if(!C(n.all("input")))return;i._insert()}else{if(!C(L.all("input")))return;if(i.imgLocalUrl.val()===b)return void alert("请先选择文件!");if(!i.suffixReg.test(i.imgLocalUrl.val()))return alert(i.suffixWarning),i.uploadForm[0].reset(),void i.imgLocalUrl.val(b);var a=e(i.fileInput[0]);if(U&&a/1e3>U)return void alert("上传图片最大："+U/1e3+"M");i.d.loading(),y.on("click",function(e){e.halt(),s.abort()});var g=l.Utils.normParams(i.cfg.serverParams)||{};g["document-domain"]=document.domain;var s=o({data:g,url:i.cfg.serverUrl,form:i.uploadForm[0],dataType:"json",type:"post",complete:function(e,t){if(y.css({left:-9999,top:-9999}),i.d.unloading(),"abort"!==t){if(e||(e={error:"服务器出错，请重试"}),e.error)return void alert(e.error);x(i.imgUrl,e.imgUrl),(new Image).src=e.imgUrl,i._insert()}}}),m=i.d.get("el"),d=m.offset(),f=m[0].offsetWidth,c=m[0].offsetHeight;y.css({left:d.left+f/2.5,top:d.top+c/1.5})}}),i.cfg){i.cfg.extraHTML&&n.one("."+a+"img-up-extraHTML").html(i.cfg.extraHTML);var I=n.one("."+a+"image-up"),U=i.cfg&&i.cfg.sizeLimit;i.fileInput=u('<input type="file" style="position:absolute;cursor:pointer;left:'+(c.ie?"360":c.chrome?"319":"369")+'px;z-index:2;top:0px;height:26px;" size="1" name="'+(i.cfg.fileInput||"Filedata")+'"/>').insertAfter(i.imgLocalUrl),U&&(b="单张图片容量不超过 "+U/1e3+" M"),i.imgLocalUrl.val(b),i.fileInput.css("opacity",0),i.fileInput.on("mouseenter",function(){I.addClass(""+a+"button-hover")}),i.fileInput.on("mouseleave",function(){I.removeClass(""+a+"button-hover")}),i.fileInput.on("change",function(){var e=i.fileInput.val();i.imgLocalUrl.val(e.replace(/.+[\/\\]/,""))}),i.imageCfg.remote===!1&&i.tab.removeItemAt(0,1)}else i.tab.removeItemAt(1,1);i._prepare=r.noop},_insert:function(){var e,i=this,t=x(i.imgUrl),n=parseInt(x(i.imgHeight),10),l=parseInt(x(i.imgWidth),10),o=i.imgAlign.get("value"),g=parseInt(i.imgMargin.val(),10),s="";n&&(s+="height:"+n+"px;"),l&&(s+="width:"+l+"px;"),"none"!==o&&(s+="float:"+o+";"),isNaN(g)||0===g||(s+="margin:"+g+"px;"),i.d.hide(),i.selectedEl?(e=i.selectedEl,i.editor.execCommand("save"),i.selectedEl.attr({src:t,_ke_saved_src:t,style:s})):(e=u("<img "+(s?'style="'+s+'"':"")+' src="'+t+'" _ke_saved_src="'+t+'" alt="" />',i.editor.get("document")[0]),i.editor.insertElement(e)),setTimeout(function(){var t,n,l,o,g=a(e),s=r.trim(x(i.imgLink)),m=i.editor.getSelection(),d=i.imgLinkBlank.attr("checked")?"_blank":"_self",f=0;if(g&&(t=g.attr("target")||"_self",s!==g.attr("href")||t!==d?(e._4eBreakParent(g),(n=e.prev())&&"a"===n.nodeName()&&!n[0].childNodes.length&&n.remove(),(l=e.next())&&"a"===l.nodeName()&&!l[0].childNodes.length&&l.remove()):f=1),!f&&s){i.selectedEl||(o=m.createBookmarks()),g=u("<a>"),g.attr("_ke_saved_href",s).attr("href",s).attr("target",d);var c=e[0];c.parentNode.replaceChild(g[0],c),g.append(c)}o?m.selectBookmarks(o):i.selectedEl&&i.editor.getSelection().selectElement(i.selectedEl),f||i.editor.execCommand("save")},100)},_update:function(e){var i,t=this,n=0,r=l.Utils.resetInput;if(t.selectedEl=e,e&&t.imageCfg.remote!==!1){x(t.imgUrl,e.attr("src"));var o=parseInt(e.style("width"),10),g=parseInt(e.style("height"),10);g?x(t.imgHeight,g):r(t.imgHeight),o?x(t.imgWidth,o):r(t.imgWidth),t.imgAlign.set("value",e.style("float")||"none");var s=parseInt(e.style("margin"),10)||0;t.imgMargin.val(s),t.imgRatio[0].disabled=!1,t.imgRatioValue=o/g,i=a(e)}else{var m=t.editor,d=m.getSelection(),f=d&&d.getCommonAncestor();f&&(i=a(f));var c=t.imageCfg.defaultMargin;void 0===c&&(c=v),2===t.tab.get("bar").get("children").length&&(n=1),t.imgLinkBlank.attr("checked",!0),r(t.imgUrl),r(t.imgLink),r(t.imgHeight),r(t.imgWidth),t.imgAlign.set("value","none"),t.imgMargin.val(c),t.imgRatio[0].disabled=!0,t.imgRatioValue=null}i?(x(t.imgLink,i.attr("_ke_saved_href")||i.attr("href")),t.imgLinkBlank.attr("checked","_blank"===i.attr("target"))):(r(t.imgLink),t.imgLinkBlank.attr("checked",!0)),t.uploadForm[0].reset(),t.imgLocalUrl.val(b);var u=t.tab;u.setSelectedTab(u.getTabAt(n))},show:function(e){var i=this;i._prepare(),i._update(e),i.d.show()},destroy:function(){var e=this;e.d.destroy(),e.tab.destroy(),e.loadingCancel&&e.loadingCancel.remove(),e.imgAlign&&e.imgAlign.destroy()}},t.exports=n});