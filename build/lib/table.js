KISSY.add('editor-plugins/lib/table',["editor","./dialog-loader","./contextmenu","./button","util","ua","dom","node"],function(S ,require, exports, module) {function e(e){function t(e){o.length>0||e[0].nodeType===b.NodeType.ELEMENT_NODE&&C.test(e.nodeName())&&!e.data("selected_cell")&&(e._4eSetMarker(a,"selected_cell",!0,void 0),o.push(e))}for(var n=e.createBookmarks(),r=e.getRanges(),o=[],a={},l=0;l<r.length;l++){var i=r[l];if(i.collapsed){var d=i.getCommonAncestor(),s=d.closest("td",void 0)||d.closest("th",void 0);s&&o.push(s)}else{var c,v=new f(i);for(v.guard=t;c=v.next();){var h=c.parent();h&&C.test(h.nodeName())&&!h.data("selected_cell")&&(h._4eSetMarker(a,"selected_cell",!0,void 0),o.push(h))}}}return u.Utils.clearAllMarkers(a),e.selectBookmarks(n),o}function t(e){for(var t=e.cells,n=0;n<t.length;n++)t[n].innerHTML="",S||p(t[n])._4eAppendBogus(void 0)}function n(e,n){var r=e.getStartElement().parent("tr");if(r){var o=r.clone(!0);o.insertBefore(r),t(n?o[0]:r[0])}}function r(t){var n;if(t instanceof u.Selection){for(var o,a,l,i,d=e(t),s=d.length,c=[],v=0;s>v;v++){l=d[v].parent();var f=l[0].rowIndex;v||(a=f-1),c[f]=l,v===s-1&&(i=f+1)}n=l.parent("table");var h=n[0].rows,m=h.length;for(o=p(m>i&&n[0].rows[i]||a>0&&n[0].rows[a]||n[0].parentNode),v=c.length;v>=0;v--)c[v]&&r(c[v]);return o}return t instanceof p&&(n=t.parent("table"),1===n[0].rows.length?n.remove():t.remove()),0}function o(e,t){var n=e.getStartElement(),r=n.closest("td",void 0)||n.closest("th",void 0);if(r)for(var o=r.parent("table"),a=r[0].cellIndex,l=0;l<o[0].rows.length;l++){var i=o[0].rows[l];if(!(i.cells.length<a+1)){r=p(i.cells[a].cloneNode(void 0)),S||r._4eAppendBogus(void 0);var d=p(i.cells[a]);t?r.insertBefore(d):r.insertAfter(d)}}}function a(e){var t,n,r,o,a=[],l=e[0]&&e[0].parent("table");for(t=0,n=e.length;n>t;t++)a.push(e[t][0].cellIndex);for(a.sort(),t=1,n=a.length;n>t;t++)if(a[t]-a[t-1]>1){r=a[t-1]+1;break}r||(r=a[0]>0?a[0]-1:a[a.length-1]+1);var i=l[0].rows;for(t=0,n=i.length;n>t&&!(o=i[t].cells[r]);t++);return o?p(o):l.prev()}function l(t){var n;if(t instanceof u.Selection){var o=e(t),i=a(o);for(n=o.length-1;n>=0;n--)o[n]&&l(o[n]);return i}if(t instanceof p){var d=t.parent("table");if(!d)return null;var s=t[0].cellIndex;for(n=d[0].rows.length-1;n>=0;n--){var c=p(d[0].rows[n]);s||1!==c[0].cells.length?c[0].cells[s]&&c[0].removeChild(c[0].cells[s]):r(c)}}return null}function i(e,t){var n=new u.Range(e[0].ownerDocument);n.moveToElementEditablePosition(e,t?!0:void 0)||(n.selectNodeContents(e),n.collapse(t?!1:!0)),n.select(!0)}function d(e){var t=e.getSelection(),n=t&&t.getStartElement(),r=n&&n.closest("table",void 0);if(!r)return void 0;var o=n.closest(function(e){var t=b.nodeName(e);return r.contains(e)&&("td"===t||"th"===t)},void 0),a=n.closest(function(e){var t=b.nodeName(e);return r.contains(e)&&"tr"===t},void 0);return{table:r,td:o,tr:a}}function s(e){var t=d(e);return t&&t.td}function c(e){var t=d(e);return t&&t.tr}function v(e){this.config=e||{}}var u=require("editor"),f=u.Walker,h=require("./dialog-loader");require("./contextmenu"),require("./button");var m=require("util"),g=require("ua"),b=require("dom"),p=require("node"),x=["tr","th","td","tbody","table"],C=/^(?:td|th)$/,S=g.ieMode<11,w={"表格属性":d,"删除表格":s,"删除列":s,"删除行":c,"在上方插入行":c,"在下方插入行":c,"在左侧插入列":s,"在右侧插入列":s},N="ke_show_border",k=(6===g.ie?["table.%2,","table.%2 td, table.%2 th,","{","border : #d3d3d3 1px dotted","}"]:[" table.%2,"," table.%2 > tr > td,  table.%2 > tr > th,"," table.%2 > tbody > tr > td,  table.%2 > tbody > tr > th,"," table.%2 > thead > tr > td,  table.%2 > thead > tr > th,"," table.%2 > tfoot > tr > td,  table.%2 > tfoot > tr > th","{","border : #d3d3d3 1px dotted","}"]).join(""),A=k.replace(/%2/g,N),E={tags:{table:function(e){var t=e.getAttribute("class"),n=parseInt(e.getAttribute("border"),10);(!n||0>=n)&&e.setAttribute("class",m.trim((t||"")+" "+N))}}},_={tags:{table:function(e){var t,n=e.getAttribute("class");n&&(t=m.trim(n.replace(N,"")),t?e.setAttribute("class",t):e.removeAttribute("class"))}}};m.augment(v,{pluginRenderUI:function(e){e.addCustomStyle(A);var t=e.htmlDataProcessor,a=t&&t.dataFilter,s=t&&t.htmlFilter;a.addRules(E),s.addRules(_);var c=this,v={"表格属性":function(){this.hide();var t=d(e);t&&h.useDialog(e,"table",c.config,{selectedTable:t.table,selectedTd:t.td})},"删除表格":function(){this.hide();var t=e.getSelection(),n=t&&t.getStartElement(),r=n&&n.closest("table",void 0);if(r){e.execCommand("save"),t.selectElement(r);var o=t.getRanges()[0];o.collapse(),t.selectRanges([o]);var a=r.parent();1===a[0].childNodes.length&&"body"!==a.nodeName()&&"td"!==a.nodeName()?a.remove():r.remove(),e.execCommand("save")}},"删除行 ":function(){this.hide(),e.execCommand("save");var t=e.getSelection();i(r(t),void 0),e.execCommand("save")},"删除列 ":function(){this.hide(),e.execCommand("save");var t=e.getSelection(),n=l(t);n&&i(n,!0),e.execCommand("save")},"在上方插入行":function(){this.hide(),e.execCommand("save");var t=e.getSelection();n(t,!0),e.execCommand("save")},"在下方插入行":function(){this.hide(),e.execCommand("save");var t=e.getSelection();n(t,void 0),e.execCommand("save")},"在左侧插入列":function(){this.hide(),e.execCommand("save");var t=e.getSelection();o(t,!0),e.execCommand("save")},"在右侧插入列":function(){this.hide(),e.execCommand("save");var t=e.getSelection();o(t,void 0),e.execCommand("save")}},f=[];m.each(v,function(e,t){f.push({content:t})}),e.addContextMenu("table",function(e){return m.inArray(b.nodeName(e),x)?!0:void 0},{width:"120px",children:f,listeners:{click:function(e){var t=e.target.get("content");v[t]&&v[t].apply(this)},beforeVisibleChange:function(e){if(e.newVal){var t=this,n=t.get("children"),r=t.get("editor");m.each(n,function(e){var n=e.get("content");!w[n]||w[n].call(t,r)?e.set("disabled",!1):e.set("disabled",!0)})}}}}),e.addButton("table",{mode:u.Mode.WYSIWYG_MODE,listeners:{click:function(){h.useDialog(e,"table",c.config,{selectedTable:0,selectedTd:0})}},tooltip:"插入表格"})}}),module.exports=v;});